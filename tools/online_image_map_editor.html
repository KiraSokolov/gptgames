<html>
<head>
	<title>Online Image Map Editor</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Essential Libraries -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"
			integrity="sha512-CeIsOAsgJnmevfCi2C7Zsyy6bQKi43utIjdA87Q0ZY84oDqnI0uwfM9+bKiIkI75lUeI00WG/+uJzOmuHlesMA=="
			crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://code.jquery.com/jquery-3.6.3.min.js"
			integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<!-- Embedded CSS -->
	<style>
		body {
			font-family: Arial, sans-serif;
			background-color: #f8f9fa;
		}
		.container {
			margin-top: 50px;
			margin-bottom: 50px;
		}
		#canvas-container {
			background-color: #fff;
			border: 1px solid #ddd;
			box-shadow: 0 0 10px rgba(0,0,0,0.1);
			margin-bottom: 20px;
			max-width: 800px;
			max-height: 600px;
			overflow: auto;
		}
		#canvas {
			max-width: 100%;
			height: auto;
		}
		.btn-group {
			margin-bottom: 20px;
		}
		.btn-group .btn {
			border-radius: 0;
		}
		.btn-group .btn.active {
			background-color: #007bff;
			border-color: #007bff;
		}
		#link-input {
			margin-bottom: 20px;
		}
		#preview-container {
			margin-top: 20px;
			text-align: center;
		}
		#preview {
			max-width: 100%;
			height: auto;
		}
	</style>
</head>
<body>
	<div class="container">
		<h1>Online Image Map Editor</h1>
		<div class="row">
			<div class="col-md-8">
				<input type="file" id="image-input" class="form-control-file mb-3" accept="image/*">
				<div id="canvas-container">
					<canvas id="canvas"></canvas>
				</div>
				<div class="btn-group btn-group-toggle" data-toggle="buttons">
					<label class="btn btn-secondary active">
						<input type="radio" name="shape" value="rect" checked> Rectangle
					</label>
					<label class="btn btn-secondary">
						<input type="radio" name="shape" value="circle"> Circle
					</label>
					<label class="btn btn-secondary">
						<input type="radio" name="shape" value="poly"> Polygon
					</label>
				</div>
				<div class="form-group">
					<label for="link-input">Link:</label>
					<input type="text" class="form-control" id="link-input" placeholder="Enter link URL">
				</div>
				<button type="button" class="btn btn-primary" id="add-area-btn">Add Area</button>
				<button type="button" class="btn btn-danger" id="remove-area-btn">Remove Area</button>
			</div>
			<div class="col-md-4">
				<div id="preview-container">
					<img src="https://placehold.co/400x300?text=Preview" alt="Preview" id="preview">
				</div>
				<div class="form-group mt-3">
					<label for="map-output">Generated &lt;map&gt;:</label>
					<textarea class="form-control" id="map-output" rows="5" readonly></textarea>
				</div>
				<button type="button" class="btn btn-success btn-block" id="save-btn">Save</button>
			</div>
		</div>
	</div>
	<!-- Functional JavaScript -->
	<script>
		// Initialize canvas
		var canvas = new fabric.Canvas('canvas');
		canvas.setWidth(800);
		canvas.setHeight(600);
		canvas.setBackgroundColor('#fff');

		// Initialize variables
		var shape = 'rect';
		var link = '';
		var areas = [];

		// Add event listeners
		$('input[name="shape"]').on('change', function () {
			shape = $(this).val();
			$('.btn-group .btn').removeClass('active');
			$(this).parent().addClass('active');
		});
		$('#link-input').on('input', function() {
			link = $(this).val();
		});
		$('#add-area-btn').on('click', function() {
			addArea();
		});
		$('#remove-area-btn').on('click', function() {
			removeArea();
		});
		$('#save-btn').on('click', function() {
			saveImageMap();
		});

		function updatePreview() {
			$('#preview').attr('src', canvas.toDataURL());
			$('#preview').attr('usemap', '#image-map');
		}

		// Add area function
		function addArea() {
			var area;
			switch (shape) {
				case 'rect':
					area = new fabric.Rect({
						left: 100,
						top: 100,
						width: 200,
						height: 100,
						fill: 'rgba(0,0,0,0.3)',
						stroke: '#000',
						strokeWidth: 2,
						lockUniScaling: true,
						link: link
					});
					break;
				case 'circle':
					area = new fabric.Circle({
						left: 100,
						top: 100,
						radius: 50,
						fill: 'rgba(0,0,0,0.3)',
						stroke: '#000',
						strokeWidth: 2,
						lockUniScaling: true,
						link: link
					});
					break;
				case 'poly':
					area = new fabric.Polygon([
						{ x: 100, y: 100 },
						{ x: 200, y: 100 },
						{ x: 150, y: 200 }
					], {
						fill: 'rgba(0,0,0,0.3)',
						stroke: '#000',
						strokeWidth: 2,
						lockUniScaling: true,
						link: link
					});
					break;
			}
			canvas.add(area);
			areas.push(area);
			canvas.renderAll();
			updatePreview();
			link = '';
			$('#link-input').val('');
		}

		// Remove area function
		function removeArea() {
			if (areas.length > 0) {
				var area = areas.pop();
				canvas.remove(area);
				canvas.renderAll();
				updatePreview();
			}
		}

		// Save image map function
		function saveImageMap() {
			var html = '';
			html += '<map name="image-map">\n';
			for (var i = 0; i < areas.length; i++) {
				var area = areas[i];
				var shape = area.get('type');
				var coords = [];
				if (shape === 'rect') {
					coords = [
						area.left,
						area.top,
						area.left + area.width,
						area.top + area.height
					];
				} else if (shape === 'circle') {
					coords = [
						area.left + area.radius,
						area.top + area.radius,
						area.radius
					];
				} else if (shape === 'poly') {
					coords = area.points.map(function (point) {
						return {
							x: area.left + point.x,
							y: area.top + point.y
						};
					}).reduce(function (a, b) {
						return a.concat([b.x, b.y]);
					}, []);
				}
				var link = area.get('link');
				html += '<area shape="' + shape + '" coords="' + coords.join(',') + '" href="' + link + '">\n';
			}
			html += '</map>';
			$('#preview').attr('src', canvas.toDataURL());
			$('#preview').attr('usemap', '#image-map');
			$('#map-output').val(html); // Set the textarea content
		}

		$('#image-input').on('change', function () {
			loadImageToCanvas(this);
		});

		$('#map-output').on('click', function () {
			$(this).select();
			document.execCommand('copy');
		});

		function loadImageToCanvas(input) {
			if (input.files && input.files[0]) {
				var reader = new FileReader();
				reader.onload = function (e) {
					var img = new Image();
					img.src = e.target.result;
					img.onload = function () {
						var imgInstance = new fabric.Image(img, {
							scaleX: canvas.width / img.width,
							scaleY: canvas.height / img.height,
						});
						canvas.setBackgroundImage(
								imgInstance,
								function () {
									canvas.renderAll();
									updatePreview(); // Update the preview
								},
								{
									scaleX: canvas.width / img.width,
									scaleY: canvas.height / img.height,
								}
						);
					};
				};
				reader.readAsDataURL(input.files[0]);
			}
		}
	</script>
</body>
</html>