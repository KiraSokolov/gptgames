<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Jigsaw Puzzle</title>
    <style>

    </style>
</head>
<body>
<header>
    <h1>Custom Jigsaw Puzzle</h1>
</header>
<main>
    <section class="difficulty-selection">
        <h2>Select Difficulty</h2>
        <select id="difficulty">
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
        </select>
    </section>
    <section class="image-upload">
        <h2>Upload Your Image</h2>
        <input type="file" id="imageUpload" accept="image/*">
    </section>
    <section class="puzzle-preview">
        <h2>Puzzle Preview</h2>
        <canvas id="previewCanvas" width="150" height="150"></canvas>
    </section>
    <section class="puzzle-board">
        <h2>Puzzle Board</h2>
        <canvas id="puzzleCanvas" width="800" height="600"></canvas>
    </section>
    <section class="game-controls">
        <button id="startButton">Start Game</button>
        <button id="saveButton">Save Progress</button>
    </section>
</main>
<footer>
    <p>&copy; 2023 Jigsaw Puzzle. All rights reserved.</p>
</footer>

<script type="text/javascript">
    // DOM elements
    const difficultySelect = document.getElementById("difficulty");
    const imageUpload = document.getElementById("imageUpload");
    const previewCanvas = document.getElementById("previewCanvas");
    const puzzleCanvas = document.getElementById("puzzleCanvas");
    const startButton = document.getElementById("startButton");
    const saveButton = document.getElementById("saveButton");

    // Variables
    let image;
    let pieces;
    let gridSize;
    let pieceWidth;
    let pieceHeight;
    let selectedPiece;

    // Event listeners
    imageUpload.addEventListener("change", loadImage);
    startButton.addEventListener("click", startGame);
    saveButton.addEventListener("click", saveProgress);
    puzzleCanvas.addEventListener("mousedown", onPuzzleCanvasMouseDown);
    puzzleCanvas.addEventListener("mousemove", onPuzzleCanvasMouseMove);
    puzzleCanvas.addEventListener("mouseup", onPuzzleCanvasMouseUp);

    // Functions

    function loadImage(event) {
        const file = event.target.files[0];
        if (!file) return;

        const fileReader = new FileReader();
        fileReader.onload = (e) => {
            image = new Image();
            image.src = e.target.result;
            image.onload = () => {
                const previewContext = previewCanvas.getContext("2d");
                previewContext.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                previewContext.drawImage(image, 0, 0, previewCanvas.width, previewCanvas.height);
            };
        };
        fileReader.readAsDataURL(file);
    }

    function startGame() {
        const difficultyMap = {easy: 3, medium: 5, hard: 7};
        gridSize = difficultyMap[difficultySelect.value];
        pieceWidth = image.width / gridSize;
        pieceHeight = image.height / gridSize;

        createPuzzlePieces();
        shufflePuzzlePieces();
    }

    function saveProgress() {
        localStorage.setItem("puzzleState", JSON.stringify(pieces));
    }

    function createPuzzlePieces() {
        pieces = [];

        for (let i = 0; i < gridSize; i++) {
            for (let j = 0; j < gridSize; j++) {
                const piece = {
                    x: j * pieceWidth,
                    y: i * pieceHeight,
                    width: pieceWidth,
                    height: pieceHeight,
                    offsetX: 0,
                    offsetY: 0,
                    isDragging: false,
                    snapped: false
                };
                pieces.push(piece);
            }
        }
    }

    function shufflePuzzlePieces() {
        // Shuffle the pieces array
        pieces.sort(() => Math.random() - 0.5);

        const puzzleContext = puzzleCanvas.getContext("2d");
        puzzleContext.clearRect(0, 0, puzzleCanvas.width, puzzleCanvas.height);

        for (let i = 0; i < pieces.length; i++) {
            const piece = pieces[i];

            // Calculate the shuffled position for each piece
            const row = Math.floor(i / gridSize);
            const col = i % gridSize;
            piece.offsetX = col * (pieceWidth + 5) + 50;
            piece.offsetY = row * (pieceHeight + 5) + 50;

            // Draw the shuffled piece on the puzzle canvas
            puzzleContext.drawImage(
                image,
                piece.x,
                piece.y,
                piece.width,
                piece.height,
                piece.offsetX,
                piece.offsetY,
                piece.width,
                piece.height
            );
        }
    }

    function onPuzzleCanvasMouseDown(event) {
        const x = event.clientX - puzzleCanvas.getBoundingClientRect().left;
        const y = event.clientY - puzzleCanvas.getBoundingClientRect().top;

        selectedPiece = pieces.find(
            (piece) =>
                x > piece.offsetX &&
                x < piece.offsetX + piece.width &&
                y > piece.offsetY &&
                y < piece.offsetY + piece.height
        );

        if (selectedPiece) {
            selectedPiece.isDragging = true;
            selectedPiece.mouseOffsetX = x - selectedPiece.offsetX;
            selectedPiece.mouseOffsetY = y - selectedPiece.offsetY;
        }
    }

    function onPuzzleCanvasMouseMove(event) {
        if (!selectedPiece || !selectedPiece.isDragging) return;

        const x = event.clientX - puzzleCanvas.getBoundingClientRect().left;
        const y = event.clientY - puzzleCanvas.getBoundingClientRect().top;

        const puzzleContext = puzzleCanvas.getContext("2d");
        puzzleContext.clearRect(0, 0, puzzleCanvas.width, puzzleCanvas.height);

        selectedPiece.offsetX = x - selectedPiece.mouseOffsetX;
        selectedPiece.offsetY = y - selectedPiece.mouseOffsetY;

        for (const piece of pieces) {
            puzzleContext.drawImage(
                image,
                piece.x,
                piece.y,
                piece.width,
                piece.height,
                piece.offsetX,
                piece.offsetY,
                piece.width,
                piece.height
            );
        }
    }

    function onPuzzleCanvasMouseUp(event) {
        if (!selectedPiece || !selectedPiece.isDragging) return;

        selectedPiece.isDragging = false;

        for (const piece of pieces) {
            if (piece === selectedPiece || piece.snapped) continue;

            if (snapPieces(selectedPiece, piece)) {
                checkIfSolved();
                break;
            }
        }
    }

    function snapPieces(piece1, piece2) {
        const snapThreshold = 10;

        if (
            Math.abs(piece1.x - (piece2.x - piece1.offsetX + piece2.offsetX)) < snapThreshold &&
            Math.abs(piece1.y - (piece2.y - piece1.offsetY + piece2.offsetY)) < snapThreshold
        ) {
            piece1.snapped = true;
            piece1.offsetX = piece2.x - piece1.x + piece2.offsetX;
            piece1.offsetY = piece2.y - piece1.y + piece2.offsetY;
            return true;
        }

        return false;
    }

    function checkIfSolved() {
        if (pieces.every((piece) => piece.snapped)) {
            alert("Congratulations! You've solved the puzzle!");
        }
    }
</script>
</body>
</html>