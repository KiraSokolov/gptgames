<!DOCTYPE html>
<html>
<head>
  <title>Tiny Wings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      background-color: #87CEFA;
      overflow: hidden;
    }

    #game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    #game-screen {
      position: relative;
      width: 100%;
      height: 100%;
    }

    #player {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background-image: url("bird.png");
      background-size: contain;
      background-repeat: no-repeat;
    }

    .hill {
      position: absolute;
      bottom: 0;
      background-color: #2ecc71;
    }

    .coin {
      position: absolute;
      bottom: 0;
    }

    #score {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 30px;
      color: white;
    }

    #fever {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 100px;
      color: #FFD700;
      text-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700, 0 0 30px #FFD700, 0 0 40px #FFD700, 0 0 50px #FFD700, 0 0 60px #FFD700, 0 0 70px #FFD700, 0 0 80px #FFD700;
      display: none;
    }

    #game-over {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 100px;
      color: white;
      text-shadow: 0 0 10px white, 0 0 20px white, 0 0 30px white, 0 0 40px white, 0 0 50px white, 0 0 60px white, 0 0 70px white, 0 0 80px white;
      display: none;
    }

    #instructions {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 20px;
      color: white;
    }

    #start-button {
      position: absolute;
      bottom: 50px;
      font-size: 50px;
      padding: 10px 20px;
      background-color: white;
      border-radius: 10px;
      cursor: pointer;
    }

    #start-button:hover {
      background-color: #eee;
    }

    #start-button:active {
      background-color: #ddd;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .perfect-slide {
      background-color: #FFD700;
    }

    .fever {
      background-color: #FFD700;
    }

    .game-over {
      background-color: rgba(0, 0, 0, 0.5);
    }

    .game-over button {
      font-size: 50px;
      padding: 10px 20px;
      background-color: white;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 20px;
    }

    .game-over button:hover {
      background-color: #eee;
    }

    .game-over button:active {
      background-color: #ddd;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.5.1/gsap.min.js"></script>
  <script type="text/javascript">
    // Constants
    const HILL_WIDTH = 400;
    const HILL_MIN_HEIGHT = 150;
    const HILL_MAX_HEIGHT = 250;
    const HILL_MIN_DISTANCE = 200;
    const HILL_MAX_DISTANCE = 300;
    const HILL_MAX_ANGLE = 45;
    const HILL_PERLIN_SCALE = 0.1;
    const PLAYER_SPEED = 4;
    const PLAYER_MIN_SPEED = 2;
    const PLAYER_MAX_SPEED = 6;
    const PLAYER_GRAVITY = 0.2;
    const PLAYER_JUMP_SPEED = -6;
    const PLAYER_DIVE_SPEED = 8;
    const PERFECT_SLIDE_THRESHOLD = 1;
    const FEVER_THRESHOLD = 10;
    const FEVER_SPEED_MULTIPLIER = 2;
    const FEVER_DURATION = 2000;
    const COIN_SIZE = 40;
    const COIN_DISTANCE = 200;
    const COIN_PROBABILITY = 0.5;
    const GAME_OVER_TIMEOUT = 1000;

    // Variables
    let hills = [];
    let coins = [];
    let playerX = 0;
    let playerY = 0;
    let playerSpeed = PLAYER_MIN_SPEED;
    let playerAngle = 0;
    let playerDiving = false;
    let playerSliding = false;
    let score = 0;
    let fever = false;
    let gameOver = false;
    let gameOverTimeout;

    // Functions
    function generateHills() {
      // Generate first hill
      let hill = {
        x: -HILL_WIDTH / 2,
        y: 0,
        height: randomInRange(HILL_MIN_HEIGHT, HILL_MAX_HEIGHT),
        distance: 0,
        angle: 0,
      };
      hills.push(hill);

      // Generate additional hills
      let prevHill = hill;
      while (prevHill.x < window.innerWidth + HILL_WIDTH / 2) {
        let hill = {
          x: prevHill.x + prevHill.distance + randomInRange(HILL_MIN_DISTANCE, HILL_MAX_DISTANCE),
          y: prevHill.y - prevHill.height,
          height: randomInRange(HILL_MIN_HEIGHT, HILL_MAX_HEIGHT),
          distance: randomInRange(HILL_MIN_DISTANCE, HILL_MAX_DISTANCE),
          angle: randomInRange(-HILL_MAX_ANGLE, HILL_MAX_ANGLE),
        };
        hills.push(hill);
        prevHill = hill;
      }
    }

    function generateCoins() {
      for (let i = 0; i < hills.length; i++) {
        let hill = hills[i];
        let x = hill.x + randomInRange(0, hill.distance);
        let y = hill.y - randomInRange(0, hill.height);
        let coin = {
          x: x,
          y: y,
          collected: false,
        };
        coins.push(coin);
      }
    }

    function updateScore() {
      $("#score").text(score);
    }

    function updateFever() {
      if (fever) {
        $("#fever").fadeIn(100).fadeOut(100);
      }
    }

    function startGame() {
      $("#instructions").hide();
      $("#start-button").hide();
      $("#game-screen").css("cursor", "none");
      playerSpeed = PLAYER_MIN_SPEED;
      playerAngle = 0;
      playerDiving = false;
      playerSliding = false;
      score = 0;
      fever = false;
      gameOver = false;
      hills.splice(0, hills.length);
      coins.splice(0, coins.length);
      generateHills();
      playerX = hills[0].x + HILL_WIDTH / 2;
      playerY = hills[0].y;
      generateCoins();
      updateScore();
      updateFever();
      updateHills();
      updatePlayer();
      updateCoins();
      gameLoop(); // Add game loop
    }

    function gameOverScreen() {
      gameOver = true;
      gameOverTimeout = setTimeout(() => {
        $("#game-over").fadeIn();
      }, GAME_OVER_TIMEOUT);
    }

    function randomInRange(min, max) {
      return Math.random() * (max - min) + min;
    }

    function updateHills() {
      let container = $("#hill-container");
      container.empty();
      let prevHill = hills[0];
      for (let i = 1; i < hills.length; i++) {
        let hill = hills[i];

        // Calculate hill width and height
        let distance = hill.x - prevHill.x;
        let heightDiff = hill.y - prevHill.y;
        let width = Math.sqrt(distance * distance + heightDiff * heightDiff);
        let height = prevHill.height - hill.height;

        // Create hill div and rotate it
        let hillDiv = $("<div>").addClass("hill");
        hillDiv.css("width", width);
        hillDiv.css("height", height);
        hillDiv.css("bottom", prevHill.height);
        hillDiv.css("left", prevHill.x);
        hillDiv.css("transform-origin", "bottom left");
        hillDiv.css("transform", `rotate(${prevHill.angle}deg)`);
        container.append(hillDiv);

        prevHill = hill;
      }
    }

    function updatePlayer() {
      let player = $("#player");

      // Move player horizontally
      playerX += playerSpeed;
      player.css("left", playerX);

      // Calculate player height and angle
      let hillIndex = Math.floor((playerX + HILL_WIDTH / 2) / HILL_WIDTH);
      if (hillIndex >= 0 && hillIndex < hills.length - 1) {
        let hill1 = hills[hillIndex];
        let hill2 = hills[hillIndex + 1];
        let t = (playerX + HILL_WIDTH / 2 - hill1.x) / (hill2.x - hill1.x);
        let height = (1 - t) * hill1.y + t * hill2.y;
        let angle = (1 - t) * hill1.angle + t * hill2.angle;
        playerY = height;
        playerAngle = angle;
      } else {
        gameOverScreen();
      }

      // Move player vertically
      playerSpeed += PLAYER_GRAVITY;
      playerY -= playerSpeed;
      if (playerY < -1000) {
        gameOverScreen();
      }
      player.css("bottom", playerY);

      // Rotate player
      player.css("transform-origin", "bottom");
      player.css("transform", `rotate(${playerAngle}deg)`);
    }

    function updateCoins() {
      let container = $("#coin-container");
      for (let i = 0; i < coins.length; i++) {
        let coin = coins[i];

        // Check if coin is within range of player
        let dx = coin.x - playerX;
        let dy = coin.y - playerY;
        let distance = Math.sqrt(dx * dx + dy * dy);
        if (distance < COIN_DISTANCE) {
          coin.collected = true;
          score++;
          updateScore();
          if (score % FEVER_THRESHOLD == 0) {
            fever = true;
            playerSpeed *= FEVER_SPEED_MULTIPLIER;
            updateFever();
            setTimeout(() => {
              fever = false;
              playerSpeed /= FEVER_SPEED_MULTIPLIER;
              updateFever();
            }, FEVER_DURATION);
          }
        }

        // Remove collected coins from DOM
        if (coin.collected) {
          $(`#coin-${i}`).remove();
        }

        // Generate new coins randomly
        if (i == coins.length - 1 && coin.x < window.innerWidth + HILL_WIDTH) {
          let prob = Math.random();
          if (prob < COIN_PROBABILITY) {
            let hillIndex = Math.floor((coin.x + HILL_WIDTH / 2) / HILL_WIDTH);
            if (hillIndex >= 0 && hillIndex < hills.length) {
              let hill = hills[hillIndex];
              let x = hill.x + randomInRange(0, hill.distance);
              let y = hill.y - randomInRange(0, hill.height);
              let newCoin = {
                x: x,
                y: y,
                collected: false,
              };
              coins.push(newCoin);
              let coinDiv = $("<div>").addClass("coin");
              coinDiv.attr("id", `coin-${coins.length - 1}`);
              coinDiv.css("left", x - COIN_SIZE / 2);
              coinDiv.css("bottom", y - COIN_SIZE / 2);
              coinDiv.css("width", COIN_SIZE);
              coinDiv.css("height", COIN_SIZE);
              container.append(coinDiv);
            }
          }
        }
      }
    }

    function checkPerfectSlide() {
      let hillIndex = Math.floor((playerX + HILL_WIDTH / 2) / HILL_WIDTH);
      if (hillIndex >= 0 && hillIndex < hills.length - 1) {
        let hill1 = hills[hillIndex];
        let hill2 = hills[hillIndex + 1];
        let t = (playerX + HILL_WIDTH / 2 - hill1.x) / (hill2.x - hill1.x);
        let height1 = hill1.y;
        let height2 = hill2.y;
        let angle1 = hill1.angle;
        let angle2 = hill2.angle;
        let diffHeight = height2 - height1;
        let diffAngle = angle2 - angle1;
        let expectedHeight = height1 + t * diffHeight;
        let expectedAngle = angle1 + t * diffAngle;
        if (Math.abs(playerAngle - expectedAngle) < PERFECT_SLIDE_THRESHOLD) {
          playerSpeed += PLAYER_GRAVITY * 2;
          $("#player").addClass("perfect-slide");
          setTimeout(() => {
            $("#player").removeClass("perfect-slide");
          }, PERFECT_SLIDE_DURATION);
        }
      }
    }

    function handleTouchStart(event) {
      if (!gameOver) {
        if (event.target.tagName != "BUTTON") {
          playerSliding = true;
          if (!playerDiving) {
            playerSpeed = PLAYER_MIN_SPEED;
          }
        }
      }
    }

    function handleTouchEnd(event) {
      if (!gameOver) {
        if (event.target.tagName != "BUTTON") {
          playerSliding = false;
          playerDiving = true;
          $("#player").addClass("diving");
        }
      }
    }

    function handleButtonClick(event) {
      if (gameOver) {
        $("#game-over").fadeOut(() => {
          startGame();
        });
      }
    }

    function gameLoop() {
      if (!gameOver) {
        updatePlayer();
        updateHills();
        updateCoins();
        updateFever();
        requestAnimationFrame(gameLoop);
      }
    }

    $(document).ready(() => {
      // Initialize event handlers
      $("#game-screen").on("touchstart", handleTouchStart);
      $("#game-screen").on("touchend", handleTouchEnd);
      $("#start-button").on("click", handleButtonClick);

      // Initialize game
      startGame();
    });
  </script>
</head>
<body>
<div id="game-container">
  <div id="game-screen">
    <div id="player"></div>
    <div id="hill-container"></div>
    <div id="coin-container"></div>
    <div id="score"></div>
    <div id="fever"></div>
    <div id="game-over"></div>
  </div>
  <div id="instructions">
    <p>Tap to slide down hills and gain speed. Release to jump. Tap again to dive.</p>
    <p>Collect coins to activate Fever mode and gain bonus points.</p>
    <p>Use Perfect Slides to gain extra speed.</p>
  </div>
  <div id="start-button">Start Game</div>
</div>
</body>
</html>
