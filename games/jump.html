<html lang="en">
<head>
  <link href="jump.css" rel="stylesheet"/>
  <title>Jumping Game</title>
</head>
<body>
<div id="wrapper">
  <div id="score">Score: 0</div>
  <div id="info">Joodle Dump!</div>
  <div id="controls">
    <button id="start-game">Start Game</button>
  </div>
  <div id="game-container"></div>
</div>
<script>
  const gameContainer = document.getElementById("game-container");
  const infoContainer = document.getElementById("info");
  const scoreContainer = document.getElementById("score");
  const controlsContainer = document.getElementById("controls");
  const containerHeight = gameContainer.clientHeight;
  const startButton = document.getElementById("start-game");
  let player, gravity, jumpForce, platformCount, platformDistance, platforms, score, keysPressed, cameraMovedUp, running;

  function init() {
    gravity = 0.5;
    jumpForce = -15;
    platformCount = 0;
    platformDistance = 50;
    platforms = [];
    score = 0;
    keysPressed = {
      left: false,
      right: false
    };
    cameraMovedUp = false;
    running = true;
  }

  document.addEventListener("keydown", event => {
      switch (event.code) {
        case "ArrowLeft":
          keysPressed.left = true;
          break;
        case "ArrowRight":
          keysPressed.right = true;
          break;
        case "Space":
          player.jump();
          break;
      }
    }
  );
  document.addEventListener("keyup", event => {
      switch (event.code) {
        case "ArrowLeft":
          keysPressed.left = false;
          break;
        case "ArrowRight":
          keysPressed.right = false;
          break;
      }
    }
  );

  function increaseScore() {
    score++;
    updateScore();
  }

  function decreaseScore() {
    score--;
    updateScore();
  }

  function updateScore() {
    scoreContainer.textContent = `Score: ${score}`;
  }

  class Platform {
    constructor(x, y, obstacle = false) {
      this.x = x;
      this.y = y;
      this.i = platformCount;
      this.jumpedOn = false;
      this.obstacle = obstacle;
      this.element = document.createElement("div");
      this.element.classList.add("platform");
      this.updateStyle();
      gameContainer.appendChild(this.element);

      if (obstacle) {
        this.element.classList.add("obstacle");
      }

      platformCount++;
    }

    updateStyle() {
      this.element.style.left = `${this.x}px`;
      this.element.style.top = `${this.y}px`;
    }

    moveDown() {
      cameraMovedUp = true;

      if (player.yVelocity < 0) {
        this.y -= player.yVelocity;
      } else {
        player.moveDown();
        return true;
      }

      this.updateStyle();

      if (this.y > containerHeight) {
        this.remove();
        platforms.splice(this.i, 1);
        updatePlatformIndices();
      }
      return false;
    }

    remove() {
      this.element.remove();
      platformCount--;
    }
  }

  function updatePlatformIndices() {
    platforms.forEach((platform, index) => {
      platform.i = index;
    })
  }

  class Player {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.element = document.createElement("div");
      this.element.id = 'player';
      this.element.textContent = String.fromCodePoint(0x1F407);
      this.element.style.height = "50px";
      this.element.style.width = "50px";
      this.element.style.position = "absolute";
      this.element.style.left = `${x}px`;
      this.element.style.top = `${y}px`;
      gameContainer.appendChild(this.element);
      this.jump();
    }

    remove() {
      this.element.remove();
    }

    jump() {
      this.yVelocity = jumpForce;
    }

    moveDown() {
      this.y += 1;
    }

    update() {
      if (keysPressed.left) {
        this.x -= 10;

        if (this.x < 0) {
          this.x = 500;
        }
      }
      if (keysPressed.right) {
        this.x += 10;

        if (this.x + 50 > 500) {
          this.x = 0;
        }
      }
      this.yVelocity += gravity;
      const playerUnderLine = this.y >= 200;
      if (playerUnderLine) {
        this.y += this.yVelocity;
      }
      this.element.style.left = `${this.x}px`;
      this.element.style.top = `${this.y}px`;
      platforms.some((platform) => {
        let playerTouchesPlatform = this.y + 50 > platform.y && this.y + 50 < platform.y + 20 && this.x + 30 > platform.x && this.x + 30 < platform.x + 100;
        let playerTouchesFloor = this.y + 50 > containerHeight;
        let playerMovesDown = this.yVelocity > 0;
        if (playerMovesDown && (playerTouchesPlatform || playerTouchesFloor)) {
          this.yVelocity = 0;
          player.jump();

          if (playerTouchesPlatform) {
            if (!platform.jumpedOn) {
              platform.jumpedOn = true;
              platform.obstacle ? gameOver() : increaseScore();
            }
          }

          if (playerTouchesFloor && cameraMovedUp) {
            return gameOver();
          }
        }

        if (!playerUnderLine) {
          return platform.moveDown();
        }
      });

      if (platforms.length < 30) {
        addPlatform();
      }
    }
  }

  function addPlatform(obstacle = false) {
    platforms.push(new Platform(Math.random() * 400, containerHeight - (platformCount * platformDistance), obstacle));
    randomlyAddObstacle();
    increasePlatformDistance();
  }

  function increasePlatformDistance() {
    if (platformDistance <= 100) {
      platformDistance += .1;
    }
  }

  function randomlyAddObstacle() {
    if (Math.floor(Math.random() * 10) === 5) {
      addObstacle();
    }
  }

  function addObstacle() {
    addPlatform(true);
  }

  function showInfo(text = '') {
    if (text) {
      infoContainer.textContent = text;
    }

    infoContainer.style.display = 'block';
  }

  function hideInfo() {
    infoContainer.style.display = "none";
  }

  function showControls() {
    controlsContainer.style.display = "block";
  }

  function hideControls() {
    controlsContainer.style.display = "none";
  }

  function gameOver() {
    running = false;
    showInfo("Game Over!");
    player.remove();
    platforms.forEach((platform) => platform.remove());
    platforms = [];
    showControls();
    return true;
  }

  function update() {
    if (running) {
      player.update();
      requestAnimationFrame(update);
    }
  }

  function start() {
    init();
    updateScore();
    hideInfo();
    hideControls();
    player = new Player(50, containerHeight);
    for (; platformCount < 30;) {
      addPlatform();
    }
    requestAnimationFrame(update);
  }

  var backgroundImage = new Image();
  backgroundImage.src = "jumpbg.png";
  backgroundImage.onload = function() {
    startButton.addEventListener("click", start);
  }
</script>
</body>
</html>
