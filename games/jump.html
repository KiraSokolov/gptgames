<html>
    <head>
        <style>
            #game-container {
                height: 800px;
                width: 500px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: solid 1px black;
                overflow: hidden;
                position: relative;
            }

            .platform {
                width: 100px;
                height: 20px;
                background-color: green;
                position: absolute;
            }
        </style>
    </head>
    <body>
        <div id="game-container"></div>
        <script>
            let player;
            let gravity = 0.5;
            let jumpForce = -15;
            let platformCount = 0;
            let platformDistance = 0;
            let platforms = [];
            let keysPressed = {
                left: false,
                right: false
            };
            const gameContainer = document.getElementById("game-container");
            const containerHeight = gameContainer.clientHeight;
            document.addEventListener("keydown", event=>{
                switch (event.code) {
                case "ArrowLeft":
                    keysPressed.left = true;
                    break;
                case "ArrowRight":
                    keysPressed.right = true;
                    break;
                case "Space":
                    player.jump();
                    break;
                }
            }
            );
            document.addEventListener("keyup", event=>{
                switch (event.code) {
                case "ArrowLeft":
                    keysPressed.left = false;
                    break;
                case "ArrowRight":
                    keysPressed.right = false;
                    break;
                }
            }
            );
            class Platform {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                    this.i = platformCount;
                    this.element = document.createElement("div");
                    this.element.classList.add("platform");
                    this.updateStyle();
                    gameContainer.appendChild(this.element);
                    platformCount++;
                }
                
                updateStyle() {
                    this.element.style.left = `${this.x}px`;
                    this.element.style.top = `${this.y}px`;
                }
                
                moveDown() {
                    if (player.yVelocity < 0) {
                        this.y -= player.yVelocity;
                    } else {
                        player.moveDown();
                        return true;
                    }
                    this.updateStyle();
                    
                    if (this.y > containerHeight) {
                      this.remove();
                    }
                    return false;
                }
                
                remove() {
                    console.log('removed', this);
                    this.element.remove();
                    platforms.forEach((platform, index) => {
                        if (platform.i > index) {
                            platform.i -= 1;
                        }
                    })
                    platforms.splice(this.i, 1);
                    platformCount--;
                }
            }
            class Player {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                    this.element = document.createElement("div");
                    this.element.style.backgroundColor = "red";
                    this.element.style.height = "50px";
                    this.element.style.width = "50px";
                    this.element.style.position = "absolute";
                    this.element.style.left = `${x}px`;
                    this.element.style.top = `${y}px`;
                    gameContainer.appendChild(this.element);
                    this.jump();
                }
                jump() {
                    this.yVelocity = jumpForce;
                }
                moveDown() {
                  this.y += 1;
                }
                update() {
                    if (keysPressed.left) {
                        this.x -= 10;
                    }
                    if (keysPressed.right) {
                        this.x += 10;
                    }
                    this.yVelocity += gravity;
                    const playerUnderLine = this.y >= 200;
                    if (playerUnderLine) {
                        this.y += this.yVelocity;
                    } else {
                      console.log('stop moving');
                    }
                    this.element.style.left = `${this.x}px`;
                    this.element.style.top = `${this.y}px`;
                    platforms.some((platform, i) => {
                        let playerTouchesPlatform = this.y + 50 > platform.y && this.y + 50 < platform.y + 20 && this.x > platform.x && this.x < platform.x + 100;
                        if (playerTouchesPlatform || this.y > containerHeight + 50) {
                            if (this.yVelocity > 0 && this.y > 0) {
                                this.yVelocity = 0;
                                player.jump();
                            }
                        }
                        
                        if (!playerUnderLine) {
                            let shouldStop = platform.moveDown();
                            return shouldStop;
                        }
                    });
                    
                    if (platformCount < 30) {
                        addPlatform(true, platforms.length);
                    }
                    
                }
            }
            function addPlatform(isNew = false, i = 0) {
                platforms.push(new Platform(Math.random() * 300 + 100, containerHeight - (platformCount*100)));
                console.log(isNew, i);
            }
            function startGame() {
                player = new Player(50, containerHeight);
                for (; platformCount < 30;) {
                    addPlatform(false, platformCount);
                }
                requestAnimationFrame(update);
            }
            function update() {
                player.update();
                requestAnimationFrame(update);
            }
            startGame();
        </script>
    </body>
</html>
